---
title: "Hood Replication Project"
author: "Jacob Hood"
date: "4/1/2021"
output: pdf_document
---

## Setting up environment 
```{r setup, include=FALSE, results = "asis"}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
p_load(tidyverse, ipumsr, kableExtra, data.table)
```

## Loading data into environment
```{r loading data}
ddi <- read_ipums_ddi("usa_00003.xml")
data <- read_ipums_micro(ddi)
crosswalk_data <- read.csv("occ_crosswalk.csv")
```

## Cleaning data
```{r selecting variables}
# Selecting variables to keep 
data_clean <- data %>%
  select(YEAR, SAMPLE, SERIAL, PERNUM, PERWT, REGION,	METRO,	NCHILD,	NCHLT5,	SEX, AGE,	MARST, RACE, HISPAN, BPL, EDUC, EDUCD, LABFORCE,	CLASSWKR, CLASSWKRD, OCC1990,	WKSWORK2,	UHRSWORK, INCWAGE)
```

```{r remove percentiles}
# Removing the top (99%) and bottom (1%) income percentiles 
data_clean <- data_clean %>% group_by(YEAR) %>% filter(INCWAGE != 0) %>% filter(INCWAGE < quantile(data_clean$INCWAGE, 0.99) & INCWAGE > quantile(data_clean$INCWAGE, 0.01))
```

```{r select correct obvs}
# Filtering out people active in labor force, black or white, ages 25-59, and not Hispanic
data_clean <- data_clean %>% 
  filter(LABFORCE == 2 & AGE <= 59 & AGE >= 25 & HISPAN == 0 & RACE < 3) %>%
  filter(EDUC != 0 & INCWAGE < 999998)
```


```{r select correct obvs}
# Filtering out values from EDUCD that are individual yeras only and not grouped categories, so we can later construct potential work experience variable
data_clean <- data_clean %>% filter(EDUCD == 011 | EDUCD ==012 |EDUCD == 014 | EDUCD ==015 | EDUCD ==016 | EDUCD ==017 | EDUCD ==022 | EDUCD ==023 | EDUCD ==025 | EDUCD ==026 | EDUCD ==030 | EDUCD ==040 |EDUCD == 050 | EDUCD ==060 | EDUCD ==070 |EDUCD == 080 |EDUCD == 090 |EDUCD == 100 |EDUCD == 110 |EDUCD == 111 |EDUCD == 112 |EDUCD == 113 |EDUCD == 114 |EDUCD == 115 |EDUCD == 116) # Removing missing values for education and income
```

```{r}
# Recoding EDUCD to Years of Schooling
data_clean <- data_clean %>% mutate(EDUY = ifelse(EDUCD == 011, 1, ifelse(EDUCD == 012, 2, ifelse(EDUCD == 014, 3, ifelse(EDUCD == 015, 4, ifelse(EDUCD == 016, 5, ifelse(EDUCD == 017, 6, ifelse(EDUCD == 022, 7, ifelse(EDUCD == 023, 8, ifelse(EDUCD == 025, 9, ifelse(EDUCD == 026, 10, ifelse(EDUCD == 030, 11, ifelse(EDUCD == 040, 12, ifelse(EDUCD == 050, 13, ifelse(EDUCD == 060, 14, ifelse(EDUCD == 070, 15, ifelse(EDUCD == 080, 16, ifelse(EDUCD == 090, 17, ifelse(EDUCD == 100, 18, ifelse(EDUCD == 110, 19, ifelse(EDUCD == 111 | 114, 20, ifelse(EDUCD == 112, 21, ifelse(EDUCD = 113 | 115, 22, 23)))))))))))))))))))))))
```

```{r}
# Joining with crosswalk data
# I have to convert the data and merge it otherwise my computer's memory gets exhausted
# So apologies for the ugly code!

names(crosswalk_data)[names(crosswalk_data) == "occ1990"] <- "OCC1990"
# Extract the data in a data.table format 
    # can be replaced by reading from a file using fread or any other command to have both data sets as data tables.
dt1 <- as.data.table(data_clean) 
dt2 <- as.data.table(crosswalk_data)

# set the merging key in each data table
setkey(dt1, "OCC1990")
setkey(dt2, "OCC1990")
# merge data tables
dt.result <- merge(dt1, dt2, by = "OCC1990")

data_clean <- as.data.frame(dt.result)
```

```{r create unique id}
# Creating unique id for each observation 
data_clean <- data_clean %>% unite("ID", "SAMPLE", "SERIAL", "PERNUM", remove = T)

nrow(data_clean)
n_distinct(data_clean$ID) # Checking that each ID is unique 
```

```{r new variables}
# Finally, create new variables for log weekly hours worked, weekly wage, log weekly wage (all adjusted for inflation), potential work experience,
# and potential work experience squared 

 # adjusting for inflation (1999 dollars)
data_clean <- data_clean %>% mutate(ADJINCWAGE = ifelse(YEAR == 1980, INCWAGE*2.295, ifelse(YEAR == 1990, INCWAGE*1.334, INCWAGE*1.000))) %>%
mutate("LOGWKSWRK" = log(WKSWORK2), "WKWAGE" = ADJINCWAGE/WKSWORK2, "LOGWKWAGE" = log(ADJINCWAGE/WKSWORK2), "PWRKEXP" = (AGE - EDUY - 6), "SQ_PWRKEXP" = PWRKEXP^2)
```

```{r new variables}
# Renaming the dummy sex and race variables to character strings, and creating a new variable for both race and gender
data_clean <- data_clean %>% mutate(GENDER = ifelse(SEX == 1, "male", "female")) %>% mutate(RACE = ifelse(RACE == 1, "white", "black" )) %>% mutate(RACEGENDER = ifelse(GENDER == "male" & RACE == "white", "white male", ifelse(GENDER == "female" & RACE== "white", "white female", ifelse(GENDER == "male" & RACE == "black", "black male", "black female")))) 
```

```{r}
# Creating variable for Foreign Born (=1)
data_clean <- data_clean %>% mutate(ForeignBorn = ifelse(BPL >= 150, 1, 0)) %>%
# Creating variable for Public Sector (=1)
mutate(PublicSector = ifelse(CLASSWKRD >= 24 & CLASSWKRD < 29, 1, 0))
```

```{r}
# Creating variable for College (=1)
data_clean <- data_clean %>% mutate(College = ifelse(EDUCD == 101, 1, 0 )) %>%

# Creating variable for Some College (=1)
mutate(SomeCol = ifelse(EDUCD > 064 & EDUCD < 101, 1, 0)) %>%

# Creating variable for High School (=1)
mutate(HSGrad = ifelse(EDUCD >= 062 & EDUCD <= 064, 1, 0)) %>%

mutate(LessHS = ifelse(EDUCD < 062, 1, 0))
```

```{r}
# Creating variable for Married (=1)
data_clean <- data_clean %>% mutate(Married = ifelse(MARST == 1 | MARST ==2, 1, 0)) %>%

# Creating variable for Presence of Child Under 5 (=1)
mutate(Child5 = ifelse(NCHLT5 == 0, 0, 1))
```

```{r}
# Creating variable for Northeast Region (=1)
data_clean <- data_clean %>% mutate(Northeast = ifelse(REGION == 11 | REGION == 12, 1, 0)) %>%

# Creating variable for Midwest Region (=1)
mutate(Midwest = ifelse(REGION == 21 | REGION == 22, 1, 0)) %>%

# Creating variable for South Region (=1)
mutate(South = ifelse(REGION == 31 | REGION == 32 | REGION == 33, 1, 0)) %>%
  
# Creating variable for West Region (=1)
mutate(West = ifelse(REGION == 42 | REGION == 43, 1, 0)) %>%

# Creating variable for Metro (=1)
 mutate(Metro = ifelse(METRO >= 2, 1, 0))
```

```{r}
test <- data_clean %>% filter(YEAR == 1980) %>% filter(RACEGENDER == "black male")
mean(test$PublicSector)
```

## Descriptive Statistics 
```{r}

```


```{r}

```

